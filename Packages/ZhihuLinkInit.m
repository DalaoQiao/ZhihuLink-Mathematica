$ZhihuLinkMarkdown::usage = "ZhihuLink \:7684\:7f13\:5b58\:76ee\:5f55.";$ZhihuLinkDirectory::usage = "ZhihuLink \:7684\:7f13\:5b58\:76ee\:5f55.";$ZhihuCookie::usage = "";$ZhihuAuth::usage = "";ZhihuConnect::usage="";ZhihuKeyLoad::usage="";
Begin["`Private`"];
$ZhihuLinkDirectory=FileNameJoin[{$UserBaseDirectory,"ApplicationData","ZhihuLink"}];$ZhihuLinkMarkdown=FileNameJoin[{$UserBaseDirectory,"ApplicationData","HTML2Markdown","Zhihu"}];ZhihuConnectCookie[cookie_String]:=Block[{zc0,auth,me,img},zc0=Select[StringSplit[StringDelete[cookie," "],";"],StringTake[#,5]=="z_c0="&];auth="Bearer "<>StringTake[First@zc0,6;;-1];me=CookiesGetMe[cookie,auth];Switch[me["error","code"],100,Text@Style["\:9a8c\:8bc1\:5931\:8d25, \:8bf7\:5237\:65b0\:6b64 cookie",Darker@Red]//Return,40352,Text@Style["\:8be5\:8d26\:53f7\:5df2\:88ab\:9650\:5236, \:8bf7\:624b\:52a8\:767b\:9646\:89e3\:9664\:9650\:5236",Darker@Red]//Return,_,Text@Style["Login Successfully!",Darker@Green]//Print];img=ImageResize[URLExecute[StringTake[me["avatar_url"],1;;-6]<>"r.jpg","jpg"],52];ZhihuLinkUserObject[<|"cookies"->cookie,"auth"->auth,"user"->me["url_token"],"img"->img,"time"->Now|>]];ZhihuConnectCookie[cookie_List,auth_String]:=Block[{me,img},me=CookiesGetMe[cookie,auth];Switch[me["error","code"],100,Text@Style["\:9a8c\:8bc1\:5931\:8d25, \:8bf7\:5237\:65b0\:6b64 cookie",Darker@Red]//Return,40352,Text@Style["\:8be5\:8d26\:53f7\:5df2\:88ab\:9650\:5236, \:8bf7\:624b\:52a8\:767b\:9646\:89e3\:9664\:9650\:5236",Darker@Red]//Return,_,Text@Style["Login Successfully!",Darker@Green]//Print];img=ImageResize[URLExecute[StringTake[me["avatar_url"],1;;-6]<>"r.jpg","jpg"],52];ZhihuLinkUserObject[<|"cookies"->cookie,"auth"->auth,"user"->me["url_token"],"img"->img,"time"->Now|>]];ZhihuConnect[id_Integer:1]:=Block[{cookie,auth,ks,key},If[Head@$ZhihuKeys===Symbol,Text@Style["\:8bf7\:5148\:67e5\:770b\:4f60\:62e5\:6709\:7684 Key!",Darker@Red]//Print;Return[$Canceled]];key=ReverseSort[$ZhihuKeys,#["Time"]&][[id]];cookie=key["Key"]["Key"];auth="Bearer "<>Select[cookie,#["Name"]=="z_c0"&][[1]]["Content"];ZhihuConnectCookie[cookie,auth]]Options[ZhihuKeyLoad]={Key->None};ZhihuKeyLoad[id_:1,OptionsPattern[]]:=Block[{ks,key},$ZhihuKeys=ZhihuKeyImport[Message->False,Key->OptionValue[Key]];If[$ZhihuKeys===$Failed,Text@Style["\:4f60\:6ca1\:6709\:5df2\:50a8\:5b58\:7684 Key!",Darker@Red]//Print;Return[$Canceled]];ks=ReverseSort[$ZhihuKeys,#["Time"]&];key=Check[ks[[id]],Print@Text@Style["\:65e0\:6b64\:7f16\:53f7",Darker@Red];Return[$Canceled]];$ZhihuCookie=key["Key"]["Key"];$ZhihuAuth="Bearer "<>Select[$ZhihuCookie,#["Name"]=="z_c0"&][[1]]["Content"];Echo[Text@Style[key["ID"],Darker@Green],"\:5f53\:524d\:52a0\:8f7d KeyID: "];];
End[];
SetAttributes[{},{Protected,ReadProtected}];