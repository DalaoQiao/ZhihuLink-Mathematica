$ZhihuKeys::usage="";ZhihuKeys::usage="";ZhihuKeyImport::usage="Import cookies from file.";ZhihuKeyExport::usage="Export a association (usually symbolize a series of cookies) into file after simple encryption.";ZhihuKeyObject::usage="";ZhihuKeyVerify::usage="\:9a8c\:8bc1\:5f53\:524d key \:7684\:53ef\:7528\:6027.";ZhihuKeyAdd::usage = "";ZhihuCookieTransform::usage="ZhihuCookieTransform[cookieraw_] takes a string of cookie and convert it into a List of Association.";ZhihuCookiesGetMe::usage="";ZhihuCookiesTimeCheck::usage="";
Begin["`Private`"];
Needs["Authentication`"];ZhihuCookieTransform[cookieraw_String]:=Flatten@StringCases[StringSplit[cookieraw,";"],StartOfString~~name:Shortest[__]~~"="~~content__~~EndOfString:><|"Name"->StringDelete[name," "],"Content"->content|>];ZhihuCookiesGetMe[cookie_,auth_]:=Block[{req=HTTPRequest["https://api.zhihu.com/people/self",<|"Headers"-><|"authorization"->auth|>,"Cookies"->cookie,"Query"->{"include"->"gender,voteup_count,follower_count,account_status"}|>]},GeneralUtilities`ToAssociations@URLExecute[req,Authentication->None,Interactive->False]]//Quiet;ZhihuCookiesTimeCheck[t_]:=Piecewise[{{Text@Style["\[Checkmark] Success!",Darker@Green],QuantityMagnitude@t<3*86400},{Text@Style["\[Chi] Fail !!",Red],QuantityMagnitude@t>86400*25}},Text@Style["¿ Need Refresh",Purple]];Format[ZhihuKeyObject[___],OutputForm]:=Print@Style["Illegal Operation!",Darker@Red];Format[ZhihuKeyObject[___],InputForm]:=Print@Style["Illegal Operation!",Darker@Red];ZhihuKeyObjectQ[asc_?AssociationQ]:=AllTrue[{"Key","Time"},KeyExistsQ[asc,#]&];ZhihuKeyObjectQ[_]=False;ZhihuKeyObject/:MakeBoxes[obj:ZhihuKeyObject[asc_?ZhihuKeyObjectQ],form:(StandardForm|TraditionalForm)]:=Module[{above,below},above={{BoxForm`SummaryItem[{"KeyID: ",Style[Hash@asc["Key"],DigitBlock->5,NumberSeparator->"-"]}],SpanFromLeft},{BoxForm`SummaryItem[{"Date: ",asc["Time"]}],SpanFromLeft}};below={{BoxForm`SummaryItem[{"Site: ",Hyperlink["https://Zhihu.com"]}],SpanFromLeft},{BoxForm`SummaryItem[{"Remark: ",asc["Mark"]}],SpanFromLeft}};BoxForm`ArrangeSummaryBox["ZhihuKey",obj,Show[Authentication`SecuredAuthenticationKey`PackagePrivate`noauthicon,ImageSize->32],above,below,form,"Interpretable"->Automatic]];ZhihuKeyObject[ass_][name_]:=Lookup[ass,name];ZhihuKeyVerify::usage="Input ANYTHING and check whether it's a valid cookie sequence.";ZhihuKeyVerify[cookie_]:=Check[Block[{req,get},Switch[Head@cookie,String,ProcessRawCookie@cookie,List,cookie,ZhihuKeyObject,cookie["Key"],_,Return["UnknowKey"]];req=HTTPRequest["http://www.zhihu.com/api/v4/members/vapor-vx/activities",<|"Headers"-><|"authorization"->"Bearer "<>Select[cookie,#["Name"]=="z_c0"&][[1]]["Content"]|>,"Cookies"->cookie,"Query"->{"limit"->20}|>];get=URLExecute[req,Authentication->None,Interactive->False];Switch[get["error","code"],100,Print@Text@Style["\:9a8c\:8bc1\:5931\:8d25, \:8bf7\:5237\:65b0\:6b64 cookie",Darker@Red];False,40352,Print@Text@Style["\:8be5\:8d26\:53f7\:5df2\:88ab\:9650\:5236, \:8bf7\:624b\:52a8\:767b\:9646\:89e3\:9664\:9650\:5236",Darker@Red];False,_,True]],Print@Text@Style["\:672a\:77e5\:9519\:8bef",Darker@Red];False];Options[ZhihuKeyExport]={Key->None};ZhihuKeyExport[ass_,OptionsPattern[]]:=Block[{file=FileNameJoin[{$ZhihuLinkDirectory,"key.wxf"}]},If[FileExistsQ@file,DeleteFile@file];BinaryWrite[file,BinarySerialize[Encrypt[Switch[OptionValue[Key],None,Uncompress@"1:eJxTTMoPClZmYGAIycgsVgCikoxUhezUSoW0/CKF5Pz87MxUheKS/KLE9FRFACiWDlA=",_,OptionValue[Key]], ass],PerformanceGoal->"Speed"]];Close[file];];Options[ZhihuKeyImport]={Key->None,Message->True};ZhihuKeyImport[OptionsPattern[]]:= Block[{file=FileNameJoin[{$ZhihuLinkDirectory,"key.wxf"}]},If[FileExistsQ@file,Decrypt[Switch[OptionValue[Key],None,Uncompress@"1:eJxTTMoPClZmYGAIycgsVgCikoxUhezUSoW0/CKF5Pz87MxUheKS/KLE9FRFACiWDlA=",_,OptionValue[Key]],BinaryDeserialize@ByteArray@BinaryReadList@file],If[OptionValue[Message],Print["no such file"];];$Failed]];ZhihuKeyAddDialog[]:=Block[{},$CookieDialog$=None;$MarkDialog$=None;DialogInput[{TextCell["\:7c98\:8d34\:4f60\:7684 Cookies"],InputField[Dynamic@$CookieDialog$,String,FieldSize->100,ImageSize->{400,400/GoldenRatio^2}],TextCell["\:5907\:6ce8\:4fe1\:606f,\:6bd4\:5982\:53ef\:4ee5\:586b\:4f60\:7684\:7528\:6237\:540d(\:53ef\:4e0d\:586b)"],InputField[Dynamic@$MarkDialog$,String,FieldSize->32.5],DefaultButton[DialogReturn["Success"]]},WindowTitle->"\:9700\:8981Token"];{$CookieDialog$,$MarkDialog$}];Options[ZhihuKeyAdd]={Key->None,Check->True};ZhihuKeyAdd[OptionsPattern[]]:=Block[{key,now,ass,cookie,mark},{cookie,mark}=ZhihuKeyAddDialog[];key=ZhihuCookieTransform@cookie;If[OptionValue[Check],If[!ZhihuKeyVerify@key,Return[$Failed]];];now=DateString@Now;ass=<|"Key"->ZhihuKeyObject[<|"Key"->key,"Time"->now,"Mark"->mark|>],"ID"->Style[Hash@key,DigitBlock->5,NumberSeparator->"-"],"Time"->now,"State"->If[OptionValue[Check],Text@Style["\[Checkmark] Verified!",Darker@Green],Text@Style["\[Chi] Unknow",Darker@Red]],"Mark"->mark|>;If[Head@$ZhihuKeys===Symbol,$ZhihuKeys=ZhihuKeyImport[Message->False,Key->OptionValue[Key]];If[$ZhihuKeys===$Failed,$ZhihuKeys={}]];DeleteDuplicatesBy[Join[$ZhihuKeys,{ass}],#["ID"]&];ZhihuKeyExport[$ZhihuKeys,Key->OptionValue[Key]];Echo[Text@Style[Hash@key,Darker@Blue,DigitBlock->5,NumberSeparator->"-"],"Successfully Add:\n"];];Options[ZhihuKeys]={Key->None};ZhihuKeys[OptionsPattern[]]:=Block[{ks},$ZhihuKeys=ZhihuKeyImport[Message->False,Key->OptionValue[Key]];If[$ZhihuKeys===$Failed,Text@Style["\:4f60\:6ca1\:6709\:5df2\:50a8\:5b58\:7684 Key!",Darker@Red]//Print;Return[$Canceled]];ks=ReverseSort[$ZhihuKeys,#["Time"]&];MapIndexed[#1/.ZhihuKeyObject[x_]->First@#2&,ks]//Dataset];
End[];
SetAttributes[{},{Protected,ReadProtected}];