ZhihuKeyImport::usage="Import cookies from file.";ZhihuKeyExport::usage="Export a association (usually symbolize a series of cookies) into file after simple encryption.";ZhihuKeyObject::usage="";ZhihuKeyVerify::usage="\:9a8c\:8bc1\:5f53\:524d key \:7684\:53ef\:7528\:6027.";
Begin["`Private`"];
Format[ZhihuKeyObject[___],OutputForm]:=Print@Style["Illegal Operation!",Darker@Red];Format[ZhihuKeyObject[___],InputForm]:=Print@Style["Illegal Operation!",Darker@Red];ZhihuKeyObjectQ[asc_?AssociationQ]:=AllTrue[{"Key","Time"},KeyExistsQ[asc,#]&];ZhihuKeyObjectQ[_]=False;ZhihuKeyObject/:MakeBoxes[obj:ZhihuKeyObject[asc_?ZhihuKeyObjectQ],form:(StandardForm|TraditionalForm)]:=Module[{above,below},above={{BoxForm`SummaryItem[{"KeyID: ",Style[Hash@asc["Key"],DigitBlock->5,NumberSeparator->"-"]}],SpanFromLeft},{BoxForm`SummaryItem[{"Date: ",asc["Time"]}],SpanFromLeft}};below={{BoxForm`SummaryItem[{"Site: ",Hyperlink["https://Zhihu.com"]}],SpanFromLeft},{BoxForm`SummaryItem[{"Remark: ",asc["Mark"]}],SpanFromLeft}};BoxForm`ArrangeSummaryBox["ZhihuKey",obj,Show[Authentication`SecuredAuthenticationKey`PackagePrivate`noauthicon,ImageSize->32],above,below,form,"Interpretable"->Automatic]];ZhihuKeyObject[ass_][name_]:=Lookup[ass,name];ZhihuKeyVerify::usage="Input ANYTHING and check whether it's a valid cookie sequence.";ZhihuKeyVerify[cookie_]:=Check[Block[{req,get},Switch[Head@cookie,String,ProcessRawCookie@cookie,List,cookie,ZhihuKeyObject,cookie["Key"],_,Return["UnknowKey"]];req=HTTPRequest["http://www.zhihu.com/api/v4/members/vapor-vx/activities",<|"Headers"-><|"authorization"->"Bearer "<>Select[cookie,#["Name"]=="z_c0"&][[1]]["Content"]|>,"Cookies"->cookie,"Query"->{"limit"->20}|>];get=URLExecute[req,Authentication->None,Interactive->False];Switch[get["error","code"],100,Print@Text@Style["\:9a8c\:8bc1\:5931\:8d25, \:8bf7\:5237\:65b0\:6b64 cookie",Darker@Red];False,40352,Print@Text@Style["\:8be5\:8d26\:53f7\:5df2\:88ab\:9650\:5236, \:8bf7\:624b\:52a8\:767b\:9646\:89e3\:9664\:9650\:5236",Darker@Red];False,_,True]],Print@Text@Style["\:672a\:77e5\:9519\:8bef",Darker@Red];False];Options[ZhihuKeyExport]={Key->None};ZhihuKeyExport[ass_,OptionsPattern[]]:=Block[{file=FileNameJoin[{$ZhihuLinkDirectory,"key.wxf"}]},BinaryWrite[file,BinarySerialize[Encrypt[Switch[OptionValue[Key],None,Uncompress@"1:eJxTTMoPClZmYGAIycgsVgCikoxUhezUSoW0/CKF5Pz87MxUheKS/KLE9FRFACiWDlA=",_,OptionValue[Key]], ass],PerformanceGoal->"Speed"]];Close[file];];Options[ZhihuKeyImport]={Key->None,Message->True};ZhihuKeyImport[OptionsPattern[]]:= Block[{file=FileNameJoin[{$ZhihuLinkDirectory,"key.wxf"}]},If[FileExistsQ@file,Decrypt[Switch[OptionValue[Key],None,Uncompress@"1:eJxTTMoPClZmYGAIycgsVgCikoxUhezUSoW0/CKF5Pz87MxUheKS/KLE9FRFACiWDlA=",_,OptionValue[Key]],BinaryDeserialize@ByteArray@BinaryReadList@file],If[OptionValue[Message],Print["no such file"];];$Failed]];
End[];
SetAttributes[{},{Protected,ReadProtected}];